#!/usr/bin/env bash
# NeuralSync-enhanced Codex CLI wrapper
# Provides memory context from NeuralSync to Codex

set -euo pipefail

# Get script directory
SCRIPT_DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"
NEURALSYNC_DIR="$( cd "${SCRIPT_DIR}/.." && pwd )"

# Set environment for NeuralSync integration
export TOOL_NAME="codex"
export NS_HOST="${NS_HOST:-127.0.0.1}"
export NS_PORT="${NS_PORT:-8373}"

# Handle special cases for codex arguments
FILTERED_ARGS=()
CONTEXT_MODE="full"

for arg in "$@"; do
    case "$arg" in
        --ask-for-approval)
            # Skip this argument as it causes conflicts with our wrapper
            echo "ℹ️  Note: --ask-for-approval disabled in NeuralSync mode" >&2
            ;;
        --no-context)
            CONTEXT_MODE="none"
            ;;
        --minimal-context)
            CONTEXT_MODE="minimal"
            export NS_MINIMAL_CONTEXT="1"
            ;;
        *)
            FILTERED_ARGS+=("$arg")
            ;;
    esac
done

# Check if we should bypass NeuralSync context (for simple commands)
BYPASS_CONTEXT=0
if [ "${#FILTERED_ARGS[@]}" -eq 0 ] || [ "$CONTEXT_MODE" = "none" ]; then
    BYPASS_CONTEXT=1
elif [ "${#FILTERED_ARGS[@]}" -eq 1 ]; then
    case "${FILTERED_ARGS[0]}" in
        --help|--version|-h|-v|help|version)
            BYPASS_CONTEXT=1
            ;;
    esac
fi

# Execute codex with or without NeuralSync context
if [ "$BYPASS_CONTEXT" -eq 1 ]; then
    # Direct execution without NeuralSync wrapper
    exec codex "${FILTERED_ARGS[@]}"
else
    # Execute through NeuralSync wrapper
    if [ -n "${FILTERED_ARGS[*]}" ]; then
        exec "${SCRIPT_DIR}/nswrap" -- codex "${FILTERED_ARGS[@]}"
    else
        exec "${SCRIPT_DIR}/nswrap" -- codex
    fi
fi